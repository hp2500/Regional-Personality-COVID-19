---
title: "COVID-19 US"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# MAC
 knitr::opts_knit$set(root.dir = normalizePath('../Data/US'))

library(Hmisc)
library(lmerTest)
library(nlme)
library(psych)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(party)
library(doParallel)
library(changepoint)
library(survival)
library(survminer)
library(censReg)
library(haven)
library(specr)
```

# Prepare county level data 
### Read and format prevalence data 
```{r, warning=FALSE, message=FALSE}
df_us_prev <- read_csv('US_prevalence.csv')

df_us_prev <- df_us_prev %>% 
  select(fips, date, rate) %>% 
  mutate(date = as.Date(date, "%d%b%Y")) %>% 
  dplyr::rename(county_fips = fips, 
         rate_day = rate) %>%
  mutate(county_fips = as.character(county_fips)) %>% 
  filter(rate_day >= 0 & rate_day <= 1000) %>%
  filter(date <= '2020-04-15')
  
df_us_prev %>% write_csv('us_prev_fips.csv')
```

```{r message=FALSE, warning=FALSE}
df_us_death <- read_csv('US_prevalence.csv')

df_us_death <-df_us_death %>%
  mutate(date = as.Date(date, "%d%b%Y"), 
         fips = as.character(fips))

df_us_death_0930 <- df_us_death %>% 
  filter(date == '2020-09-30') %>% 
  dplyr::rename(county_fips = fips,
         case_rate_0930 = rate,
         death_rate_0930 = rate_death) %>% 
  select(county_fips, case_rate_0930, death_rate_0930)

df_us_death_0415 <- df_us_death %>% 
  filter(date == '2020-04-15') %>% 
  dplyr::rename(county_fips = fips,
         case_rate_0415 = rate,
         death_rate_0415 = rate_death) %>% 
  select(county_fips, case_rate_0415, death_rate_0415)

df_us_death <- merge(df_us_death_0415, df_us_death_0930)

# save df
df_us_death %>% write_csv('us_death_county_maps.csv')
```

### Read and format personality data 
```{r, warning=FALSE, message=FALSE}
df_us_pers <- read_csv('US_personality_2.csv')

df_us_pers %>% filter(freq >= 50) %>% .$freq %>% sd()

df_us_pers <- df_us_pers %>%
  dplyr::rename(county_fips = county,
         pers_o = open, 
         pers_c = sci,
         pers_e = extra,
         pers_a = agree,
         pers_n = neuro) %>%
  filter(freq >= 50) %>% 
  select(-county_name, -freq) %>%
  mutate(county_fips = as.character(county_fips))

df_us_pers %>% .$freq %>% mean
```

### Read and format county level controls 
```{r message=FALSE, warning=FALSE}
df_us_ctrl <- read.csv('US_controls_2.csv')

df_us_ctrl <- df_us_ctrl %>% select(-county_name) %>%
  rename(county_fips = county,
         airport_dist = airport_distance,
         conservative = republican,
         age = medage,
         healthcare = physician_pc) %>%
  mutate(county_fips = as.character(county_fips), 
         male=male*100,
         tourism=tourism*100,
         manufact=manufact*100,
         academics=academics*100)

df_us_temp <- read_csv("US_controls_weather.csv") %>% 
  filter(month %in% c('Mar')) %>% 
  group_by(fips) %>% summarise(temp = mean(tempc)) %>%
  rename(county_fips = fips) %>% 
  mutate(county_fips = as.character(as.numeric(county_fips)))

df_us_ctrl <- df_us_ctrl %>% plyr::join(df_us_temp, 'county_fips')

```

### Read and format social distancing data FB
```{r, warning=FALSE, message=FALSE}
fb_files <- list.files('../FB Data/US individual files',
                       '*.csv', full.names = T)

df_us_socdist <- fb_files %>% 
  map(read_csv) %>% 
  bind_rows()

df_us_socdist <- df_us_socdist %>%
  select(-age_bracket, -gender, -baseline_name, 
         -baseline_type, -polygon_name) %>%
  rename(date = ds,
         county_fips = polygon_id,
         socdist_tiles = all_day_bing_tiles_visited_relative_change,
         socdist_single_tile = all_day_ratio_single_tile_users) %>%
  mutate(county_fips = as.character(county_fips))
 
# save object for descritives 
df_us_socdist_desc <- df_us_socdist
```

### Merge prevalence data
```{r message=FALSE, warning=FALSE}
# create sequence of dates
date_sequence <- seq.Date(min(df_us_prev$date),
                          max(df_us_prev$date), 1)
                     
# create data frame with time sequence
df_dates = data.frame(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')

# join data frames
df_us_prev <- df_us_prev %>%
  plyr::join(df_us_ctrl, by='county_fips') %>% 
  plyr::join(df_us_pers, by='county_fips') %>%
  merge(df_dates, by='date') %>% 
  arrange(county_fips, date) %>% 
  drop_na()

df_us_prev %>% select(-date, -rate_day, -time) %>% 
  distinct() %>% write_csv('df_us_pers_fips.csv')

df_us_prev %>% select(county_fips) %>% distinct() %>% nrow()
```

```{r message=FALSE, warning=FALSE}
# join data frames 
df_us_death <- df_us_death %>%
  plyr::join(df_us_ctrl, by='county_fips') %>% 
  plyr::join(df_us_pers, by='county_fips') %>%
  drop_na()

# save df
df_us_death %>% 
  #select(county_fips, case_rate, death_rate) %>% 
  write_csv('us_death_fips_controls.csv')
```

### Merge social distancing data
```{r message=FALSE, warning=FALSE}
# create sequence of dates
date_sequence <- seq.Date(min(df_us_socdist$date),
                          as.Date('2020-04-28'), 1)
                     
# create data frame with time sequence
df_dates = data.frame(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')

# join data frames 
df_us_socdist <- df_us_socdist %>%
  plyr::join(df_us_ctrl, by='county_fips') %>% 
  plyr::join(df_us_pers, by='county_fips') %>%
  inner_join(df_dates, by='date') %>% 
  arrange(county_fips, date)

fips_complete <- df_us_socdist %>% 
  group_by(county_fips) %>% 
  summarise(n = n()) %>% 
  filter(! n<max(n)) %>% .$county_fips

df_us_socdist <- df_us_socdist %>%
  filter(county_fips %in% fips_complete)

df_us_socdist %>% select(county_fips) %>% distinct() %>% nrow()
```

### Control for weekend effect 
```{r message=FALSE, warning=FALSE}
easter <- seq.Date(as.Date('2020-04-10'), as.Date('2020-04-13'), 1)

df_us_loess <- df_us_socdist %>% 
  mutate(weekday = format(date, '%u')) %>% 
  filter(!weekday %in% c('6','7') | date %in% easter) %>% 
  split(.$county_fips) %>%
  map(~ loess(socdist_single_tile ~ time, data = .)) %>%
  map(predict, 1:max(df_us_socdist$time)) %>% 
  bind_rows() %>% 
  gather(key = 'county_fips', value = 'loess') %>% 
  group_by(county_fips) %>% 
  mutate(time = row_number())

df_us_loess_2 <- df_us_socdist %>% 
  mutate(weekday = format(date, '%u')) %>% 
  filter(!weekday %in% c('6','7') | date %in% easter) %>% 
  split(.$county_fips) %>%
  map(~ loess(socdist_tiles ~ time, data = .)) %>%
  map(predict, 1:max(df_us_socdist$time)) %>% 
  bind_rows() %>% 
  gather(key = 'county_fips', value = 'loess') %>% 
  rename(loess_2 = loess) %>%
  group_by(county_fips) %>% 
  mutate(time = row_number())

df_us_socdist <- df_us_socdist %>% 
  merge(df_us_loess, by=c('county_fips', 'time')) %>% 
  merge(df_us_loess_2, by=c('county_fips', 'time')) %>% 
  mutate(weekday = format(date, '%u')) %>% 
  mutate(socdist_single_tile_clean = ifelse(weekday %in% c('6','7') | date %in% easter, 
                                            loess, socdist_single_tile),
         socdist_tiles_clean = ifelse(weekday %in% c('6','7') | date %in% easter, 
                                            loess_2, socdist_tiles)) %>%
  arrange(county_fips, time) %>% 
  select(-weekday)

df_us_socdist <- df_us_socdist %>% drop_na() %>% mutate(time = time-1)
```

### Pick cleaned social distancing metrics
```{r message=FALSE, warning=FALSE}
df_us_socdist <- df_us_socdist %>% 
  mutate(socdist_single_tile = socdist_single_tile_clean,
         socdist_tiles = socdist_tiles_clean) %>% 
  select(-loess, -loess_2, -socdist_single_tile_clean, -socdist_tiles_clean)
```


# Define outcomes of interest
### COVID - Extract onset
```{r message=FALSE, warning=FALSE}
# get onset day
df_us_onset_prev <- df_us_prev %>% 
  group_by(county_fips) %>%
  filter(rate_day > 0.1) %>%
  summarise(onset_prev = min(time))

# merge with county data
df_us_onset_prev <- df_us_prev %>%
  select(-date, -time, -rate_day) %>%
  distinct() %>%
  mutate(county_fips = as.character(county_fips)) %>%
  left_join(df_us_onset_prev, by = 'county_fips')

# handle censored data
df_us_onset_prev <- df_us_onset_prev %>%
  mutate(event = ifelse(is.na(onset_prev), 0, 1)) %>%
  mutate(onset_prev = replace_na(onset_prev, as.numeric(diff(range(df_us_prev$date)))+1))
```

### COVID - Extract slopes
```{r message=FALSE, warning=FALSE}
# cut time series
df_us_prev <- df_us_prev %>% 
  filter(date > '2020-03-15' & date < '2020-04-15')

# extract slope prevalence
df_us_slope_prev <- df_us_prev %>% 
  split(.$county_fips) %>% 
  map(~ lm(log(rate_day+1) ~ time, data = .)) %>%
  map(coef) %>% 
  map_dbl('time') %>% 
  as.data.frame() %>% 
  rownames_to_column('county_fips') %>% 
  rename(slope_prev = '.')
  
# merge with county data
df_us_slope_prev <- df_us_onset_prev %>% 
  inner_join(df_us_slope_prev, by = 'county_fips')

# get unscaled object for descriptives
df_us_prev_desc <- df_us_slope_prev
```

```{r message=FALSE, warning=FALSE}
# cut time series before onset
df_us_slope_var <- df_us_prev %>% 
  filter(date <= '2020-05-15') %>%
  group_by(county_fips) %>% 
  filter(rate_day > 0.1) %>%
  mutate(time = time-min(time)+1) %>% 
  ungroup() %>%
  filter(time <= 30)

# extract slope prevalence
df_us_slope_var <- df_us_slope_var %>% 
  split(.$county_fips) %>% 
  map(~ lm(log(rate_day+1) ~ time, data = .)) %>%
  map(coef) %>% 
  map_dbl('time') %>% 
  as.data.frame() %>% 
  rownames_to_column('county_fips') %>% 
  rename(slope_prev_var = '.')

# merge with county data
df_us_slope_prev <- df_us_slope_prev %>% 
  left_join(df_us_slope_var, by = 'county_fips') %>%
  mutate(slope_prev_var = replace_na(slope_prev_var, 0))
```

### Social Distancing - Change point analysis
```{r message=FALSE, warning=FALSE}
# keep only counties with full data
fips_complete <- df_us_socdist %>% 
  group_by(county_fips) %>% 
  summarise(n = n()) %>% 
  filter(n==max(.$n)) %>% 
  .$county_fips

# run changepoint analysis
df_us_socdist_cpt_results <- df_us_socdist %>% 
  select(county_fips, socdist_single_tile) %>%
  filter(county_fips %in% fips_complete) %>% 
  split(.$county_fips) %>%
  map(~ cpt.meanvar(as.vector(.$socdist_single_tile),
                    #penalty = 'Asymptotic',
                    class=TRUE,
                    param.estimates=TRUE,
                    Q=1,
                    test.stat = 'Normal'))

df_us_socdist_cpt_results_2 <- df_us_socdist %>% 
  select(county_fips, socdist_tiles) %>%
  filter(county_fips %in% fips_complete) %>% 
  split(.$county_fips) %>%
  map(~ cpt.meanvar(as.vector(.$socdist_tiles),
                    #penalty = 'Asymptotic',
                    class=TRUE,
                    param.estimates=TRUE,
                    Q=1,
                    test.stat = 'Normal'))

# calculate change point
df_us_socdist_cpt_day <- df_us_socdist_cpt_results %>% 
  map(cpts) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(cpt_day_socdist = '.') %>%
  rownames_to_column('county_fips')

df_us_socdist_cpt_day_2 <- df_us_socdist_cpt_results_2 %>% 
  map(cpts) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(cpt_day_socdist_2 = '.') %>%
  rownames_to_column('county_fips')

# calculate mean differences
df_us_socdist_cpt_mean_diff <- df_us_socdist_cpt_results %>% 
  map(param.est) %>% 
  map(~ .$mean) %>% 
  map(~ .[2]) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(mean_diff_socdist = '.') %>%
  rownames_to_column('county_fips')

df_us_socdist_cpt_mean_diff_2 <- df_us_socdist_cpt_results_2 %>% 
  map(param.est) %>% 
  map(~ .$mean) %>% 
  map(~ -.[2]) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(mean_diff_socdist_2 = '.') %>%
  rownames_to_column('county_fips')

# calculate means
df_us_socdist_mean <- df_us_socdist %>%
  group_by(county_fips) %>%
  summarise(mean_socdist = mean(socdist_single_tile))

df_us_socdist_mean_2 <- df_us_socdist %>%
  group_by(county_fips) %>%
  summarise(mean_socdist_2 = -mean(socdist_tiles))

# merge with county data
df_us_cpt_socdist <- df_us_socdist %>% 
  select(-time, -date, -socdist_single_tile, -socdist_tiles) %>%
  distinct() %>% 
  left_join(df_us_socdist_cpt_day, by='county_fips') %>%
  left_join(df_us_socdist_cpt_day_2, by='county_fips') %>%
  left_join(df_us_socdist_cpt_mean_diff, by='county_fips') %>%
  left_join(df_us_socdist_cpt_mean_diff_2, by='county_fips') %>%
  left_join(df_us_socdist_mean, by='county_fips') %>%
  left_join(df_us_socdist_mean_2, by='county_fips') %>%
  left_join(select(df_us_onset_prev, county_fips, onset_prev), by='county_fips') %>%
  left_join(select(df_us_slope_prev, county_fips, slope_prev), by='county_fips') 

# handle censored data
df_us_cpt_socdist <- df_us_cpt_socdist %>% 
  mutate(cpt_day_socdist = ifelse(is.na(cpt_day_socdist), as.numeric(diff(range(df_us_socdist$date))), cpt_day_socdist)) %>% 
  mutate(event = ifelse(cpt_day_socdist >= as.numeric(diff(range(df_us_socdist$date))), 0, 1))
```

### Remove incomplete cases
```{r message=FALSE, warning=FALSE}

df_us_prev_unscaled <- inner_join(df_us_slope_prev, df_us_cpt_socdist %>% select(county_fips), by='county_fips')
df_us_death_unscaled <- inner_join(df_us_death, df_us_cpt_socdist %>% select(county_fips), by='county_fips')
df_us_socdist_unscaled <- inner_join(df_us_cpt_socdist, df_us_slope_prev %>% select(county_fips), by='county_fips')

fips_list <- df_us_prev_unscaled %>% select(county_fips)

df_us_prev_unscaled %>% merge(df_us_death_unscaled %>% select(county_fips:death_rate_0930))  %>%
  merge(df_us_socdist_unscaled %>% select(county_fips, cpt_day_socdist_2, mean_diff_socdist_2)) %>% 
  select(-event) %>% write_csv('us_all_variables.csv')
```


### Rescale Data
```{r message=FALSE, warning=FALSE}
df_us_prev_scaled <- df_us_prev_unscaled %>% 
  mutate_at(vars(-county_fips, -event), scale)
```

```{r message=FALSE, warning=FALSE}
df_us_death_scaled <- df_us_death_unscaled %>% 
  mutate_at(vars(-county_fips), scale)
```

```{r message=FALSE, warning=FALSE}
df_us_socdist_scaled <- df_us_socdist_unscaled %>%
  mutate_at(vars(-county_fips, -event), scale)
```


### Calculate spatial lags 
```{r message=FALSE, warning=FALSE}
# create UDF to calculate lagged variables
calc_lags <- function(df, weights, cols){
  
  cols_only <- df %>% select(cols)
  cols_lag <- weights %*% as.matrix(cols_only) %>% 
  as.matrix() %>% as.data.frame()
names(cols_lag) <- paste0(names(cols_lag), '_lag')

return(cols_lag)
}
```

```{r message=TRUE, warning=TRUE}
# read_weight matrix 
weight_mat_norm <- read_csv('df_us_spatial_weights_matrix.csv')

weight_mat_norm <- weight_mat_norm %>% select(-county_fips) %>% as.matrix()
```

```{r message=FALSE, warning=FALSE}
# generate spatially lagged y 
y_only <- df_us_prev_scaled %>% select(onset_prev,slope_prev,slope_prev_var) %>% names()
y_lag <- calc_lags(df_us_prev_scaled, weight_mat_norm, y_only)

# generate spatially lagged X
X_only <- df_us_prev_scaled %>% select(airport_dist:pers_n) %>% names()
X_lag <- calc_lags(df_us_prev_scaled, weight_mat_norm, X_only)

# bind new variables to df
df_us_prev_scaled <- cbind(df_us_prev_scaled, y_lag, X_lag)

```

```{r message=FALSE, warning=FALSE}
# generate spatially lagged y 
y_only <- df_us_death_scaled %>% select(case_rate_0415:death_rate_0930) %>% names()
y_lag <- calc_lags(df_us_death_scaled, weight_mat_norm, y_only)

# generate spatially lagged X
X_only <- df_us_death_scaled %>% select(airport_dist:pers_n) %>% names()
X_lag <- calc_lags(df_us_death_scaled, weight_mat_norm, X_only)

# bind new variables to df
df_us_death_scaled <- cbind(df_us_death_scaled, y_lag, X_lag)

```

```{r message=FALSE, warning=FALSE}
# generate spatially lagged y 
y_only <- df_us_socdist_scaled %>% select(cpt_day_socdist_2,mean_diff_socdist_2) %>% names()
y_lag <- calc_lags(df_us_socdist_scaled, weight_mat_norm, y_only)

# generate spatially lagged X
X_only <- df_us_socdist_scaled %>% select(airport_dist:pers_n) %>% names()
X_lag <- calc_lags(df_us_socdist_scaled, weight_mat_norm, X_only)

# bind new variables to df
df_us_socdist_scaled <- cbind(df_us_socdist_scaled, y_lag, X_lag)

```

```{r message=FALSE, warning=FALSE}
write_csv(df_us_prev_scaled, 'df_us_slope_prev.csv')
write_csv(df_us_death_scaled, 'df_us_death_scaled.csv')
write_csv(df_us_socdist_scaled, 'df_us_cpt_socdist.csv')
```

# Run Specification Curve Analysis 
```{r message=FALSE, warning=FALSE}
# define function to calculate specification curve analyses for all traits
spec_calculate <- function(df, y, model, controls, all.comb = T){
  
  spec_results_o <- run_specs(df = df, 
                       y = c(y), x = c("pers_o"), 
                       model = c(model), controls = controls, 
                       all.comb = all.comb)
  
  spec_results_c <- run_specs(df = df, 
                       y = c(y), x = c("pers_c"), 
                       model = c(model), controls = controls, 
                       all.comb = all.comb)
  
  spec_results_e <- run_specs(df = df, 
                       y = c(y), x = c("pers_e"), 
                       model = c(model), controls = controls, 
                       all.comb = all.comb)
  
  spec_results_a <- run_specs(df = df, 
                       y = c(y), x = c("pers_a"), 
                       model = c(model), controls = controls, 
                       all.comb = all.comb)
  
  spec_results_n <- run_specs(df = df, 
                       y = c(y), x = c("pers_n"), 
                       model = c(model), controls = controls, 
                       all.comb = all.comb)
  
  spec_results <- list(spec_results_o, spec_results_c, spec_results_e, 
                      spec_results_a, spec_results_n)
  
  names(spec_results) <- list('spec_results_o', 'spec_results_c', 'spec_results_e', 
                      'spec_results_a', 'spec_results_n')

  return(spec_results)
  }
```


```{r message=FALSE, warning=FALSE}

# adapted from specr package code
format_results <- function(df, var, null = 0, desc = FALSE) {

  # rank specs
  if (isFALSE(desc)) {
    df <- df %>%
      dplyr::arrange(!! var)
  } else {
    df <- df %>%
      dplyr::arrange(desc(!! var))
  }

  # create rank variable and color significance
  df <- df %>%
    dplyr::mutate(specifications = 1:nrow(df),
                  color = case_when(conf.low > null ~ "#377eb8",
                                    conf.high < null ~ "#e41a1c",
                                    TRUE ~ "darkgrey"))
  return(df)
}


# define function to plot single specification curve
plot_curves <- function(results, filename, hr=F){
  
  file_path_eps <- paste0("../../Plots/US/", filename,".eps")
  file_path_pdf <- paste0("../../Plots/US/", filename,".pdf")
  file_path_png <- paste0("../../Plots/US/", filename,".png")

  if(hr==F){
    
    results %>%
    format_results(var = .$estimate, null = 0, desc = F) %>%
    ggplot(aes(x = specifications,
               y = estimate,
               ymin = conf.low,
               ymax = conf.high,
               color = color)) +
    geom_point(aes(color = color),
               size = 1) +
    theme_minimal() +
    scale_color_identity() +
    theme(strip.text = element_blank(),
          axis.line = element_line("black", size = .5),
          legend.position = "none",
          panel.spacing = unit(.75, "lines"),
          axis.text = element_text(colour = "black")) +
    labs(x = "") +
      geom_pointrange(alpha = 0.05,
                      size = .6,
                      fatten = 1) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "", y = "standarized coefficient") + 
      coord_fixed(ratio = 2000, ylim = c(-0.4, 0.4)) +
      theme(panel.border = element_blank(), panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(), 
            axis.line = element_line(colour = "black")) +
      ggsave(file=file_path_eps, device = 'eps')+
      ggsave(file=file_path_pdf, device = 'pdf')+
      ggsave(file=file_path_png, device = 'png')
    
  }else{
    
    results %>%
    format_results(var = .$estimate, null = 1, desc = F) %>%
    ggplot(aes(x = specifications,
               y = estimate,
               ymin = conf.low,
               ymax = conf.high,
               color = color)) +
    geom_point(aes(color = color),
               size = 1) +
    theme_minimal() +
    scale_color_identity() +
    theme(strip.text = element_blank(),
          axis.line = element_line("black", size = .5),
          legend.position = "none",
          panel.spacing = unit(.75, "lines"),
          axis.text = element_text(colour = "black")) +
    labs(x = "") +
      geom_pointrange(alpha = 0.05,
                      size = .6,
                      fatten = 1) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
    labs(x = "", y = "standarized coefficient") + 
      coord_fixed(ratio = 2000, ylim = c(0.6, 1.4)) +
      theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(), 
      axis.line = element_line(colour = "black")) +
      ggsave(file=file_path_eps, device = 'eps')+
      ggsave(file=file_path_pdf, device = 'pdf')+
      ggsave(file=file_path_png, device = 'png')  
    }
  
}

# define function to plot all curves in list
plot_all_curves <- function(ls, analysis, hr=F){
  
  pers <- c('o', 'c', 'e', 'a', 'n')
  filenames <- as.list(paste0(analysis, '_', pers))
  hr <- as.list(rep(hr, 5))
  pmap(list(ls, filenames, hr), plot_curves)
}
```


```{r message=FALSE, warning=FALSE}
# define function to calculate summary stats for single specification curve
calc_summary <- function(df){
  
  dft <- df %>% select(estimate:fit_nobs)
  dft <- dft %>% mutate(significant = as.numeric(p.value<0.05),
                        positive = as.numeric(statistic>0), 
                        negative = as.numeric(statistic<0), 
                        significant_positive = as.numeric(p.value<0.05 & statistic>0),
                        significant_negative = as.numeric(p.value<0.05 & statistic<0))
  
  mean_temp <- dft %>% map_if(is.numeric, mean, .else=NULL) %>% as.data.frame()
  sd_temp <- dft %>% map_if(is.numeric, sd, .else=NULL) %>% as.data.frame()
  
  df_temp <- rbind(mean_temp, sd_temp)
  row.names(df_temp) <- c('mean', 'sd')
  
  return(df_temp)
}

# define function to calculate summary stats for all curves in list
calc_all_summaries <- function(ls){
  
  ls <- ls %>% map(calc_summary)
  names(ls) <- c('pers_o', 'pers_c', 'pers_e', 'pers_a', 'pers_n')
  return(ls)
}

```

```{r message=FALSE, warning=FALSE}
coef_to_hr <- function(df){
  
  df %>% mutate(conf.low = exp(estimate-1.96*std.error),
           conf.high = exp(estimate+1.96*std.error),
           estimate = exp(estimate)) 
}

filter_socdist <- function(df){
  
  df %>% filter(str_detect(controls, 'onset_prev') & 
                  str_detect(controls, 'slope_prev'))
}
```

```{r message=FALSE, warning=FALSE}
covariates <- c("airport_dist", "conservative", 'male', 'age', 'popdens',
                'manufact', 'tourism', 'academics', 'medinc', 'healthcare',
                'temp')
```


## Predict Onset
```{r message=FALSE, warning=FALSE}
cox_model <- function(formula, data){
  formula <- as.formula(formula)
  coxph(formula = formula, data = data)}
```

```{r message=FALSE, warning=FALSE}
cox_onset_prev <- spec_calculate(df = df_us_prev_scaled, 
               y = "Surv(onset_prev, event)", 
               model = "cox_model", 
               controls = covariates %>% append('onset_prev_lag'),
               all.comb = T)

cox_onset_prev_hr <- cox_onset_prev %>% map(coef_to_hr)

calc_all_summaries(cox_onset_prev_hr)

plot_all_curves(cox_onset_prev_hr, 'cox_onset_prev_hr', hr = T)
```

```{r message=FALSE, warning=FALSE}
cox_onset_prev_ctrl <- coxph(Surv(onset_prev, event) ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + onset_prev_lag, 
                             data = df_us_prev_scaled)

summary(cox_onset_prev_ctrl)
```


# Predict Slopes
```{r message=FALSE, warning=FALSE}
# fixed time windows
lm_slope_prev <- spec_calculate(df = df_us_prev_scaled, 
               y = "slope_prev", 
               model = "lm", 
               controls = covariates %>% append('slope_prev_lag'),
               all.comb = T)

calc_all_summaries(lm_slope_prev)

plot_all_curves(lm_slope_prev, 'lm_slope_prev')

```


```{r message=FALSE, warning=FALSE}
lm_slope_prev_ctrl <- lm(slope_prev ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + slope_prev_lag, 
                             data = df_us_prev_scaled)

summary(lm_slope_prev_ctrl)
```


```{r message=FALSE, warning=FALSE}
# variable time windows
lm_slope_prev_var <- spec_calculate(df = df_us_prev_scaled, 
               y = "slope_prev_var", 
               model = "lm", 
               controls = covariates %>% append('slope_prev_var_lag'),
               all.comb = T)

calc_all_summaries(lm_slope_prev_var)

plot_all_curves(lm_slope_prev_var, 'lm_slope_prev_var')
```

```{r message=FALSE, warning=FALSE}
lm_slope_prev_var_ctrl <- lm(slope_prev_var ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + slope_prev_var_lag, 
                             data = df_us_prev_scaled)

summary(lm_slope_prev_var_ctrl)
```


# Predict Cases
```{r message=FALSE, warning=FALSE}
lm_cases_0415 <- spec_calculate(df = df_us_death_scaled, 
               y = "case_rate_0415", 
               model = "lm", 
               controls = covariates %>% append('case_rate_0415_lag'),
               all.comb = T)

calc_all_summaries(lm_cases_0415)

plot_all_curves(lm_cases_0415, 'lm_cases_0415')
```

```{r message=FALSE, warning=FALSE}
lm_cases_0415_ctrl <- lm(case_rate_0415 ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + case_rate_0415_lag, 
                             data = df_us_death_scaled)

summary(lm_cases_0415_ctrl)
```


```{r message=FALSE, warning=FALSE}
lm_cases_0930 <- spec_calculate(df = df_us_death_scaled, 
               y = "case_rate_0930", 
               model = "lm", 
               controls = covariates %>% append('case_rate_0930_lag'),
               all.comb = T)

calc_all_summaries(lm_cases_0930)

plot_all_curves(lm_cases_0930, 'lm_cases_0930')
```
```{r message=FALSE, warning=FALSE}
lm_cases_0930_ctrl <- lm(case_rate_0930 ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + case_rate_0930_lag, 
                             data = df_us_death_scaled)

summary(lm_cases_0930_ctrl)
```

# Predict Deaths
```{r message=FALSE, warning=FALSE}
lm_deaths_0415 <- spec_calculate(df = df_us_death_scaled, 
               y = "death_rate_0415", 
               model = "lm", 
               controls = covariates %>% append('death_rate_0415_lag'),
               all.comb = T)

calc_all_summaries(lm_deaths_0415)

plot_all_curves(lm_deaths_0415, 'lm_deaths_0415')
```

```{r message=FALSE, warning=FALSE}
lm_deaths_0415_ctrl <- lm(death_rate_0415 ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + death_rate_0415_lag, 
                             data = df_us_death_scaled)

summary(lm_deaths_0415_ctrl)
```


```{r message=FALSE, warning=FALSE}
lm_deaths_0930 <- spec_calculate(df = df_us_death_scaled, 
               y = "death_rate_0930", 
               model = "lm", 
               controls = covariates %>% append('death_rate_0930_lag'),
               all.comb = T)

calc_all_summaries(lm_deaths_0930)

plot_all_curves(lm_deaths_0930, 'lm_deaths_0930')
```

```{r message=FALSE, warning=FALSE}
lm_deaths_0930_ctrl <- lm(death_rate_0930 ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + death_rate_0930_lag, 
                             data = df_us_death_scaled)

summary(lm_deaths_0930_ctrl)
```

# Predict Socdist Onset
```{r message=FALSE, warning=FALSE}
cox_onset_socdist <- spec_calculate(df = df_us_socdist_scaled, 
               y = "Surv(cpt_day_socdist_2, event)", 
               model = "cox_model", 
               controls = covariates %>% 
                 append(c('cpt_day_socdist_2_lag', 'onset_prev', 'slope_prev')),
               all.comb = T)

cox_onset_socdist <- cox_onset_socdist %>% map(filter_socdist)

cox_onset_socdist_hr <- cox_onset_socdist %>% map(coef_to_hr)

calc_all_summaries(cox_onset_socdist_hr)

plot_all_curves(cox_onset_socdist_hr, 'cox_onset_socdist_hr', hr = T)
```

```{r message=FALSE, warning=FALSE}
cox_onset_socdist_ctrl <- coxph(Surv(cpt_day_socdist_2, event) ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + onset_prev + slope_prev +
                                 cpt_day_socdist_2_lag, 
                             data = df_us_socdist_scaled)

summary(cox_onset_socdist_ctrl)
```

# Predict Socdist Mean
```{r message=FALSE, warning=FALSE}
lm_mean_socdist <- spec_calculate(df = df_us_socdist_scaled, 
               y = "mean_diff_socdist_2", 
               model = "lm", 
               controls = covariates %>% 
                 append(c('mean_diff_socdist_2_lag', 'onset_prev', 'slope_prev')), 
               all.comb = T)

lm_mean_socdist <- lm_mean_socdist %>% map(filter_socdist)

calc_all_summaries(lm_mean_socdist)

plot_all_curves(lm_mean_socdist, 'lm_mean_socdist')
```


```{r message=FALSE, warning=FALSE}
lm_mean_socdist_ctrl <- lm(mean_diff_socdist_2 ~ airport_dist + 
                               conservative + male + age + popdens + manufact +
                               tourism + academics + medinc + healthcare + 
                               temp + onset_prev + slope_prev +
                                 mean_diff_socdist_2_lag,
                             data = df_us_socdist_scaled)

summary(lm_mean_socdist_ctrl)
```


# Save all results 
```{r}
results_us <- list(cox_onset_prev_hr, lm_slope_prev, lm_slope_prev_var, 
                   lm_cases_0415, lm_cases_0930, lm_deaths_0415, lm_deaths_0930, 
                   cox_onset_socdist_hr, lm_mean_socdist)

names(results_us) <- list('cox_onset_prev_hr', 'lm_slope_prev', 'lm_slope_prev_var', 
                   'lm_cases_0415', 'lm_cases_0930', 'lm_deaths_0415', 'lm_deaths_0930', 
                   'cox_onset_socdist_hr', 'lm_mean_socdist')

save(results_us, file="US_spec_results.RData")
```



# Descriptives
### Distributions
```{r message=FALSE, warning=FALSE}
death_temp <- df_us_death_unscaled %>% select(county_fips:death_rate_0930)
onset_temp <- df_us_prev_unscaled %>% select(county_fips, onset_prev, slope_prev)

df_us_desc <- df_us_socdist_unscaled %>% 
  plyr::join(death_temp, by="county_fips") %>%
  dplyr::select(pers_o, pers_c, pers_e, pers_a, pers_n, 
                age, male, conservative, 
                academics, medinc, manufact, 
                airport_dist, tourism, healthcare, popdens,
                temp, onset_prev, slope_prev, 
                case_rate_0415, case_rate_0930, death_rate_0415, death_rate_0930,
                cpt_day_socdist_2, mean_diff_socdist_2)
          

df_us_desc %>% select(age) %>% summary()

us_means <- df_us_desc %>% summarise_all(mean)
us_sd <- df_us_desc %>% summarise_all(sd)

desc_us <- rbind(us_means, us_sd) %>% t() %>% round(3) %>% as.data.frame() 
names(desc_us) <- c('mean', 'sd')
desc_us %>% rownames_to_column() %>% write_csv('us_descriptives.csv')
desc_us
```

### Explore correlations
```{r message=FALSE, warning=FALSE}
a <- df_us_socdist_unscaled %>% select(county_fips, pers_o:pers_n, cpt_day_socdist, mean_diff_socdist)
b <- df_us_prev_unscaled %>% select(county_fips, onset_prev, slope_prev)
c <- df_us_death_unscaled %>% select(county_fips, case_rate_0415:death_rate_0930)

us_joined <- plyr::join_all(list(a, b, c), by='county_fips')

us_joined %>% select(-county_fips) %>% cor(use = 'pairwise.complete')
```


```{r message=FALSE, warning=FALSE}
us_means <- us_joined %>% select(-county_fips) %>% summarise_all(mean)
us_sd <- us_joined %>% select(-county_fips) %>% summarise_all(sd)

desc_us <- rbind(us_means, us_sd) %>% t() %>% round(3) %>% as.data.frame() %>%
  rename(mean=V1, sd=V2)

desc_us %>% rownames_to_column() %>% write_csv('us_descriptives.csv')
desc_us  
```

# Visualization
### Example Plots
```{r message=FALSE, warning=FALSE}
# get county names
counties <- read_csv('US_personality_2.csv') %>%
  select(county, county_name) %>%
  dplyr::rename(county_fips = county) %>%
  mutate(county_fips = as.character(county_fips)) %>%
  distinct()

df_us_prev <- read_csv('US_prevalence.csv')

df_us_prev <- df_us_prev %>% 
  select(fips, date, rate) %>% 
  mutate(date = as.Date(date, "%d%b%Y")) %>% 
  dplyr::rename(county_fips = fips, 
         rate_day = rate) %>%
  mutate(county_fips = as.character(county_fips)) %>% 
  filter(rate_day >= 0 & rate_day <= 1000)

# merge with processed data frames
df_us_prev <- df_us_prev %>% inner_join(counties, by = 'county_fips')
df_us_socdist <- df_us_socdist %>% inner_join(counties, by = 'county_fips')
```

```{r message=FALSE, warning=FALSE}
gg_prev <- df_us_prev %>% 
  filter(county_fips == '8037' | county_fips == '19079') %>%
  filter(date >= '2020-03-1' & date <= '2020-05-01') %>%
  mutate(window = ifelse(date >= '2020-03-15' & date <= '2020-04-15', 
                         'in window', 'out of window')) %>%
  ggplot(aes(x=date, y=rate_day)) + 
  geom_point(aes(col=county_name)) + 
  geom_line(aes(col=county_name)) + 
  theme_light() +
  theme(legend.position="bottom", legend.margin=margin(t=-20)) +
  guides(color=guide_legend(title="")) +
  annotate('rect', xmin = as.Date('2020-03-15'), 
           xmax = as.Date('2020-04-15'), 
           ymin = -Inf, ymax = Inf, alpha = 0.07) +
  geom_segment(aes(x = as.Date('2020-04-07'), y = 0, 
                   xend = as.Date('2020-04-07'), yend = 1), 
               colour = "#00BFC4") +
  geom_segment(aes(x = as.Date('2020-03-09'), y = 0, 
                   xend = as.Date('2020-03-09'), yend = 1), 
               colour = "#F8766D") +
  annotate("text", x = as.Date('2020-04-07'), 
           y = 2, label = "Onset \n Hamilton County", color = "#00BFC4", size = 3) +
  annotate("text", x = as.Date('2020-03-09'), 
           y = 2, label = "Onset \n Eagle County", color = "#F8766D", size = 3) +
  annotate("text", x = as.Date('2020-03-31'), 
           y = 9.5, label = "Time window used for\nanalysis of growth rates", 
           color = "grey50", size = 3) +
  ylab('Prevalence') +
  xlab('') +
  ylim(c(-1,10)) +
  ggtitle("COVID-19 - comparison of onsets and \n growth rates in two counties") +
  theme(plot.title = element_text(size=11)) +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

gg_prev
```


```{r message=FALSE, warning=FALSE}

gg_socdist <- df_us_socdist %>% 
  filter(county_fips == 19137 | county_fips == 36081) %>%
  filter(date >= '2020-03-1' & date <= '2020-05-01') %>%
  ggplot(aes(x=date, y=socdist_tiles)) + 
  #facet_wrap(~countyname) +
  geom_point(aes(col=county_name)) + 
  geom_line(aes(col=county_name)) + 
  theme_light() +
  theme(legend.position="bottom",legend.margin=margin(t=-20)) +
  guides(color=guide_legend(title="")) +
    geom_segment(aes(x = as.Date('2020-03-23'), y = -.6, 
                   xend = as.Date('2020-03-23'), yend = 0), 
               colour = "#00BFC4") +
  geom_segment(aes(x = as.Date('2020-03-23'), y = -.6, 
                   xend = as.Date('2020-04-28'), yend = -.6), 
               colour = "#00BFC4") +
  geom_segment(aes(x = as.Date('2020-03-14'), y = -.156, 
                   xend = as.Date('2020-03-14'), yend = .17), 
               colour = "#F8766D") +
  geom_segment(aes(x = as.Date('2020-03-14'), y = -.156, 
                   xend = as.Date('2020-04-28'), yend = -.156), 
               colour = "#F8766D") +
  annotate("text", x = as.Date('2020-03-26'), 
           y = .08, label = "Change point\nQueens County", color = "#00BFC4", size = 3) +
  annotate("text", x = as.Date('2020-03-16'), 
           y = .25, label = "Change point\nMontgommery County", color = "#F8766D", size = 3) +
  ylab('Social distancing') +
  xlab("") +
  ylim(c(-.7,.3)) +
  ggtitle("Social distancing - comparison of change \n points and means in two counties") + 
  theme(plot.title = element_text(size=11)) +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

gg_socdist
```

```{r message=FALSE, warning=FALSE}
figure <- ggarrange(gg_prev, gg_socdist,
                    labels = c("A", "B"),
                    ncol = 2, nrow = 1)
figure
```

```{r message=FALSE, warning=FALSE}
# create sequence of dates
date_sequence <- seq.Date(min(df_us_prev$date),
                          max(df_us_prev$date), 1)
                     
# create data frame with time sequence
df_dates = data.frame(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')

tto <- df_us_prev_unscaled %>%
  merge(df_dates, by.x = 'onset_prev', by.y = 'time') %>%
  filter(event==1) %>%
  ggplot(aes(x=date+1)) +
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - COVID-19 Onset') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Date of March')
  
soa <- df_us_slope_prev %>% 
  ggplot(aes(x=slope_prev)) +
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - COVID-19 Growth Rates') +
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Standardized growth rates')


figure <- ggarrange(tto, soa,
                    labels = c("", ""),
                    ncol = 2, nrow = 1)
figure
```

```{r message=FALSE, warning=FALSE}
tto <- df_us_death_unscaled %>% 
  ggplot(aes(x=case_rate_0930)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Cumulative Case Rates') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Cases Per 1000 Inhabitants')
  
soa <- df_us_death_unscaled %>%
  ggplot(aes(x=death_rate_0930)) +
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Cumulative Death Rates') +
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Deaths Per 1000 Inhabitants')


figure <- ggarrange(tto, soa,
                    labels = c("", ""),
                    ncol = 2, nrow = 1)
figure
```

```{r message=FALSE, warning=FALSE}
# create sequence of dates
date_sequence <- seq.Date(min(df_us_socdist$date),
                          max(df_us_socdist$date), 1)
                     
# create data frame with time sequence
df_dates = data.frame(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')

tto <- df_us_cpt_socdist %>% 
  merge(df_dates, by.x = 'cpt_day_socdist_2', by.y = 'time') %>%
  filter(cpt_day_socdist_2 < 30) %>% 
  ggplot(aes(x=date+1)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Time to Adoption') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Date') +
  xlim(c(as.Date('2020-03-01'), as.Date('2020-03-31')))

soa <- df_us_cpt_socdist %>% 
  ggplot(aes(x=mean_diff_socdist_2)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Strength of Adjustment') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Standardized mean difference') 


figure <- ggarrange(tto, soa,
                    labels = c("", ""),
                    ncol = 2, nrow = 1)
figure
```

# Robustness check FB mobility data
```{r message=FALSE, warning=FALSE}
df_us_google <- read_csv("../Google/2020_US_Region_Mobility_Report.csv")

df_us_fb <- df_us_socdist %>%
  select(county_fips, date, socdist_tiles, socdist_single_tile)

df_us_ggl <- df_us_google %>% 
  select(census_fips_code, date,
         retail_and_recreation_percent_change_from_baseline:residential_percent_change_from_baseline) %>%
  drop_na() %>%
  mutate(county_fips = as.character(as.numeric(census_fips_code))) %>%
  select(-census_fips_code)

df_us_fb_ggl <- df_us_fb %>% plyr::join(df_us_ggl, c('county_fips', 'date')) %>% drop_na()

df_us_fb_ggl %>% split(.$county_fips) %>%
  map(~ map_if(., is.numeric, scale)) %>%
  bind_rows() %>%
  select(socdist_tiles:residential_percent_change_from_baseline) %>%
  drop_na() %>%
  cor() %>% 
  as.data.frame() %>%
  select(c(1,2)) %>% round(3) %>% write.csv()
```

# Visualize distribution of effect sizes
```{r}
load("US_spec_results.RData")
load("../GER/GER_spec_results.RData")
```

```{r}
plot_dist <- function(df, filename){
  
  w <- 5
  h <- 5
  
  file_path_eps <- paste0("../../Plots/COMP/", filename,".eps")
  file_path_pdf <- paste0("../../Plots/COMP/", filename,".pdf")
  file_path_png <- paste0("../../Plots/COMP/", filename,".png")
  
    
      ggplot(df, aes(x=estimate, fill=country), alpha=.3) + 
        geom_histogram(alpha=.5, position="identity") +
      #coord_fixed(ratio = 0.1) +
        theme_bw() +
      theme(panel.border = element_blank(), panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(), 
            axis.line = element_line(colour = "black")) +
        theme(axis.title.x=element_blank(),
              axis.text.y=element_blank(),
              axis.title.y=element_blank()) +
        theme(legend.position="none") +
      ggsave(file=file_path_eps, device = 'eps', width=w, height=h)+
      ggsave(file=file_path_pdf, device = 'pdf', width=w, height=h)+
      ggsave(file=file_path_png, device = 'png', width=w, height=h)
    
    
}

# define function to plot all curves in list
plot_all_dist <- function(ls, analysis, hr=F){
  
  pers <- c('o', 'c', 'e', 'a', 'n')
  filenames <- as.list(paste0(analysis, '_', pers))
  pmap(list(ls, filenames), plot_dist)
}
```


```{r}
join_results <- function(list_us, list_ger){
  
  US = "US"
  GER = "GER"

  list_us <- list_us %>% 
    map(~cbind(.x, US) %>% rename(country=US))
  list_ger <- list_ger %>% 
    map(~cbind(.x, GER) %>% rename(country=GER))
  
  map2(list_us, list_ger, rbind)
  
}
```

```{r}
join_results(results_us$cox_onset_prev_hr, results_ger$cox_onset_prev_hr) %>% 
  plot_all_dist(analysis = 'cox_onset_prev_hr')

join_results(results_us$lm_slope_prev, results_ger$lm_slope_prev) %>% 
  plot_all_dist(analysis = 'lm_slope_prev')

join_results(results_us$lm_slope_prev_var, results_ger$lm_slope_prev_var) %>% 
  plot_all_dist(analysis = 'lm_slope_prev_var')

join_results(results_us$lm_cases_0415, results_ger$lm_cases_0331) %>% 
  plot_all_dist(analysis = 'lm_cases_0415')

join_results(results_us$lm_cases_0930, results_ger$lm_cases_0930) %>% 
  plot_all_dist(analysis = 'lm_cases_0930')

join_results(results_us$lm_deaths_0415, results_ger$lm_deaths_0331) %>% 
  plot_all_dist(analysis = 'lm_deaths_0415')

join_results(results_us$lm_deaths_0930, results_ger$lm_deaths_0930) %>% 
  plot_all_dist(analysis = 'lm_deaths_0930')

join_results(results_us$cox_onset_socdist_hr, results_ger$cox_onset_socdist_hr) %>% 
  plot_all_dist(analysis = 'cox_onset_socdist_hr')

join_results(results_us$lm_mean_socdist, results_ger$lm_mean_socdist) %>% 
  plot_all_dist(analysis = 'lm_mean_socdist')

```

```{r}

calculate_effsize <- function(df){
  df %>% summarise(d = effsize::cohen.d(estimate ~ country)$estimate, 
                   pval = t.test(estimate ~ country, var.equal = TRUE)$p.value)
}

all_ttest <- map2(results_us, results_ger, join_results) %>% flatten() %>%
  map(calculate_effsize) %>% bind_rows(.id = "model")
models <- rep(names(results_us), each=5)
all_ttest <- cbind(models, all_ttest)

all_ttest

save(all_ttest, file='ttest_results.RData')
```


