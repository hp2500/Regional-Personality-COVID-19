---
title: "COVID-19 US"
author: "Heinrich Peters"
date: "4/15/2020"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# MAC
 knitr::opts_knit$set(root.dir = '/Users/hp2500/Google Drive/STUDY/Columbia/Research/Corona/Data/US')

library(lmerTest)
library(nlme)
library(psych)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(party)
library(doParallel)



```


# Prepare county level data 

### Read and format prevalence data 
```{r, warning=FALSE, message=FALSE}
df_us_covid <- read_csv('timeseries_usa_county_march1_april_09.csv')
df_us_covid <- df_us_covid %>% 
  filter(time <=31) %>% 
  arrange(countyfips) %>%
  mutate(stabil = -stabil) %>%
  dplyr::rename(county_fips = countyfips,
         pers_o = open, 
         pers_c = sci,
         pers_e = extra,
         pers_a = agree,
         pers_n = stabil)

df_us_covid %>% head()
```


### Social distancing data unacast
```{r, warning=FALSE, message=FALSE}

df_us_socdist <- read_csv('0409_sds-full-county.csv')

# create sequence of dates
date_sequence <- seq.Date(as.Date('2020-03-09'),
                          as.Date('2020-03-31'), 1)
                     

# create data frame with time sequence
df_dates = tibble(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')

# merge day index with gps data
df_us_socdist = df_us_socdist %>% 
  merge(df_dates, by='date') %>% 
  arrange(county_fips) %>%
  as_tibble()

df_us_socdist %>% head()
```

### Social distancing data FB
```{r, warning=FALSE, message=FALSE}

fb_files <- list.files('../FB Data/US individual files/Mobility/',
                       '*.csv', full.names = T)

df_us_socdist_fb <- fb_files %>% 
  map(read_csv) %>% bind_rows()

df_us_socdist_fb <- df_us_socdist_fb %>%
  select(-age_bracket, -gender, -baseline_name, -baseline_type) %>%
  rename(date = ds,
         county_fips = polygon_id,
         county_name = polygon_name,
         socdist_tiles = all_day_bing_tiles_visited_relative_change,
         socdist_single_tile = all_day_ratio_single_tile_users)

df_us_socdist_fb <- df_us_socdist_fb %>%
  filter(date >= '2020-03-09' & date <= '2020-03-31') %>%
  group_by(county_fips) %>% 
  arrange(date) %>% 
  mutate(time = row_number()) %>%
  ungroup() %>% 
  arrange(county_fips)

head(df_us_socdist_fb)
```


### Merge data
```{r}
df_us <- plyr::join_all(list(df_us_covid, df_us_socdist_fb), 
                  by = c('county_fips', 'time'), 
                  type = 'inner') %>% 
  arrange(county_fips, time)

df_us %>% head()

```

## Explore data
### Plot distributions
```{r, warning=FALSE}

# distribution of observations per county
df_us %>% group_by(county_fips) %>% 
  summarise(mark = mean(mark)) %>% 
  ggplot(aes(x=mark)) + 
  geom_histogram(color="black", fill="white", binwidth = 300) +
  ggtitle('Distribution of observations per county')

  
# distributions of mean prevalence rates per county
df_us %>% group_by(county_fips) %>% 
  summarise(rate_day = mean(rate_day)) %>%
  ggplot(aes(x=rate_day)) + 
  geom_histogram(color="black", fill="white", binwidth = 0.01) +
  ggtitle('Distribution of mean prevalence rates by county')

  
# distribution of mean sd distance measue
df_us %>% group_by(county_fips) %>% 
  summarise(socdist_tiles = mean(socdist_tiles)) %>%
  ggplot(aes(x=socdist_tiles)) + 
  geom_histogram(color="black", fill="white", bins = 200) +
 ggtitle('Distribution of mean tiles visited measure by county')


# distribution of mean sd visit measue
df_us %>% group_by(county_fips) %>% 
  summarise(socdist_single_tile = mean(socdist_single_tile)) %>%
  ggplot(aes(x=socdist_single_tile)) + 
  geom_histogram(color="black", fill="white", bins = 200) +
  ggtitle('Distribution of mean single tile measute by county')


```


```{r}

df_us %>% group_by(county_fips) %>% 
  slice(n()) %>% 
  group_by(state) %>% 
  dplyr::summarise(county_n = n()) %>% 
  ggplot(aes(x=state, y=county_n)) +
  geom_bar(stat="identity") + 
  ggtitle('Counties per state') +
  coord_flip()


df_us %>% 
  group_by(state) %>% 
  dplyr::summarise(individual_n = sum(mark)) %>% 
  ggplot(aes(x=state, y=individual_n)) +
  geom_bar(stat="identity") +
  ggtitle('Individuals per state') +
  coord_flip()  


```

### Plot social distancing by tiles visited
```{r}

df_us %>% sample_n(10000) %>%
  ggplot(aes(x=time, y=socdist_tiles)) + 
  geom_point(aes(col=county_name, size=mark)) + 
  geom_smooth(method="loess", se=T) + 
  theme(legend.position="none") +
  ggtitle("Overall social distancing (tiles visited) over time")

pers <- c('pers_o', 'pers_c', 'pers_e', 'pers_a', 'pers_n')

for (i in pers){

gg <- df_us %>% mutate(dist_tail = cut(.[[i]], 
                                       breaks = c(-Inf, quantile(.[[i]], 0.05), quantile(.[[i]], 0.95), Inf),
                                       labels = c('lower tail', 'center', 'upper tail'))) %>% 
  filter(dist_tail != 'center') %>%
  ggplot(aes(x=time, y=socdist_tiles)) + 
  geom_point(aes(col=county_name, size=mark)) + 
  geom_smooth(method="loess", se=T) + 
  facet_wrap(~dist_tail) + 
  theme(legend.position="none") +
  ggtitle(i)

print(gg)
}

```


### Plot prevalence over time
```{r}

df_us %>% sample_n(10000) %>%
  ggplot(aes(x=time, y=rate_day)) + 
  geom_point(aes(col=county_name, size=mark)) + 
  geom_smooth(method="loess", se=T) + 
  theme(legend.position="none") +
  ggtitle("Overall prevalence over time")



pers <- c('pers_o', 'pers_c', 'pers_e', 'pers_a', 'pers_n')

for (i in pers){

gg <- df_us %>% mutate(prev_tail = cut(.[[i]], 
                                       breaks = c(-Inf, quantile(.[[i]], 0.05), quantile(.[[i]], 0.95), Inf),
                                       labels = c('lower tail', 'center', 'upper tail'))) %>% 
  filter(prev_tail != 'center') %>%
  ggplot(aes(x=time, y=rate_day)) + 
  geom_point(aes(col=county_name, size=mark)) + 
  geom_smooth(method="loess", se=T) + 
  facet_wrap(~prev_tail) + 
  theme(legend.position="none") +
  ggtitle(i)

print(gg)
}

```


### Correlations 

```{r}

df_us %>% dplyr::select(county_fips, population, acad_share, medianage,
                        rep2012, male_share, medianinc, lifeexp_2010_14, 
                        foreign_share, popdens, pers_o, pers_a, pers_e, 
                        pers_c, pers_n, mark, rate_day, socdist_tiles, 
                        socdist_single_tile) %>% 
  group_by(county_fips) %>%
  summarize_if(is.numeric, mean) %>% 
  select(-county_fips) %>%
  cor(use='pairwise.complete.obs') %>% 
  round(3)
  
```


# Model building

## Prepare functions

```{r}

# function calculates all relevant models
run_models <- function(y, lvl1_x, lvl2_x, lvl2_id, data, ctrls=F){

  # subset data
  data = data %>% 
    dplyr::select(all_of(y), all_of(lvl1_x), all_of(lvl2_x), all_of(lvl2_id), 
                  popdens, all_of(y))
  data = data %>% 
    dplyr::rename(y = all_of(y),
           lvl1_x = all_of(lvl1_x),
           lvl2_x = all_of(lvl2_x),
           lvl2_id = all_of(lvl2_id)
           )
  
  # configure optimization procedure
  ctrl_config <- lmeControl(opt = 'optim', maxIter = 100, msMaxIter = 100)

  # baseline
  baseline <- lme(fixed = y ~ 1, random = ~ 1 | lvl2_id, 
                    data = data,
                    correlation = corAR1(),
                  control = ctrl_config,
                  method = 'ML')

  # random intercept fixed slope
  random_intercept <- lme(fixed = y ~ lvl1_x + lvl2_x, 
                          random = ~ 1 | lvl2_id,
                            data = data,
                            correlation = corAR1(),
                  control = ctrl_config,
                  method = 'ML')

  # random intercept random slope
  random_slope <- lme(fixed = y ~ lvl1_x + lvl2_x, 
                      random = ~ lvl1_x | lvl2_id, 
                        data = data,
                        correlation = corAR1(),
                  control = ctrl_config,
                  method = 'ML')

  # cross level interaction
  interaction <- lme(fixed = y ~ lvl1_x * lvl2_x, 
                     random = ~ lvl1_x | lvl2_id, 
                       data = data,
                       correlation = corAR1(),
                  control = ctrl_config,
                  method = 'ML')
  
  # create list with results
  results <- list('baseline' = baseline, 
                  "random_intercept" = random_intercept, 
                  "random_slope" = random_slope,
                  "interaction" = interaction)
  
  
  if (ctrls == 'dem' | ctrls == 'prev'){
    
    # random intercept random slope
    random_slope_ctrl_dem <- lme(fixed = y ~ lvl1_x + lvl2_x + popdens,
                              random = ~ lvl1_x | lvl2_id, 
                          data = data,
                          correlation = corAR1(),
                    control = ctrl_config,
                  method = 'ML')
  
    # cross level interaction
    interaction_ctrl_main_dem <- lme(fixed = y ~ lvl1_x * lvl2_x + popdens,
                             random = ~ lvl1_x | lvl2_id, 
                         data = data,
                         correlation = corAR1(),
                    control = ctrl_config,
                  method = 'ML')
  
    # cross level interaction
    interaction_ctrl_int_dem <- lme(fixed = y ~ lvl1_x * lvl2_x + lvl1_x * popdens,
                             random = ~ lvl1_x | lvl2_id, 
                         data = data,
                         correlation = corAR1(),
                    control = ctrl_config,
                  method = 'ML')        
    
    # create list with results
    results <- list('baseline' = baseline, 
                    "random_intercept" = random_intercept, 
                    "random_slope" = random_slope,
                    "interaction" = interaction,
                    "random_slope_ctrl_dem" = random_slope_ctrl_dem,
                    "interaction_ctrl_main_dem" = interaction_ctrl_main_dem,
                    "interaction_ctrl_int_dem" = interaction_ctrl_int_dem)
  }
  
  if (ctrls == 'prev'){
  
    # random intercept random slope
    random_slope_ctrl_prev <- lme(fixed = y ~ lvl1_x + lvl2_x + popdens + rate_day,
                              random = ~ lvl1_x + rate_day | lvl2_id, 
                          data = data,
                          correlation = corAR1(),
                          control = ctrl_config,
                  method = 'ML')  
    
        # cross level interaction
    interaction_ctrl_main_prev <- lme(fixed = y ~ lvl1_x * lvl2_x + popdens + rate_day,
                             random = ~ lvl1_x | lvl2_id, 
                         data = data,
                         correlation = corAR1(),
                    control = ctrl_config,
                  method = 'ML')
  
  
    # cross level interaction
    interaction_ctrl_int_prev<- lme(fixed = y ~ lvl1_x * lvl2_x + lvl1_x * popdens + rate_day,
                             random = ~ lvl1_x + rate_day | lvl2_id, 
                         data = data,
                         correlation = corAR1(),
                          control = ctrl_config,
                  method = 'ML')
  
    # create list with results
    results <- list('baseline' = baseline, 
                    "random_intercept" = random_intercept, 
                    "random_slope" = random_slope,
                    "interaction" = interaction,
                    "random_slope_ctrl_dem" = random_slope_ctrl_dem,
                    "interaction_ctrl_main_dem" = interaction_ctrl_main_dem,
                    "interaction_ctrl_int_dem" = interaction_ctrl_int_dem,                    
                    "random_slope_ctrl_prev" = random_slope_ctrl_prev,
                    "interaction_ctrl_main_prev" = interaction_ctrl_main_prev,
                    "interaction_ctrl_int_prev" = interaction_ctrl_int_prev)
  }
  
  if(ctrls == 'exp'){
    # random intercept random slope
  random_slope_exp <- lme(fixed = y ~ (lvl1_x + I(lvl1_x^2)) + lvl2_x, 
                      random = ~ (lvl1_x + I(lvl1_x^2)) | lvl2_id, 
                        data = data,
                        correlation = corAR1(),
                  control = ctrl_config,
                  method = 'ML')

  # cross level interaction
  interaction_exp <- lme(fixed = y ~ (lvl1_x + I(lvl1_x^2)) * lvl2_x, 
                     random = ~ (lvl1_x + I(lvl1_x^2)) | lvl2_id, 
                       data = data,
                       correlation = corAR1(),
                  control = ctrl_config,
                  method = 'ML')  
  
  
  # create list with results
  results <- list('baseline' = baseline, 
                  "random_intercept" = random_intercept, 
                  "random_slope" = random_slope,
                  "interaction" = interaction,                  
                  "random_slope_exp" = random_slope_exp,
                  "interaction_exp" = interaction_exp)
  }
  
  return(results)
        
}

# extracts table with coefficients and tests statistics
extract_results <- function(models) {
  
  models_summary <- models %>% 
  map(summary) %>% 
  map("tTable") %>% 
  map(as.data.frame) %>% 
  map(round, 10) 
  # %>% map(~ .[str_detect(rownames(.), 'Inter|lvl'),])
  
  return(models_summary)
  
}


compare_models <- function(models) {

  mdl_names <- models %>% names()
  
  str = ''
  for (i in mdl_names){
    
    mdl_str <- paste('models$', i, sep = '')
    
    if(i == 'baseline'){
      str <- mdl_str
    }else{
    str <- paste(str, mdl_str, sep=', ')
    }
  }
  
  anova_str <- paste0('anova(', str, ')')
  mdl_comp <- eval(parse(text=anova_str))
  rownames(mdl_comp) = mdl_names
  return(mdl_comp)
}


```

## Rescale Data
```{r}
df_us_scaled <- df_us %>% dplyr::select(county_fips, date, time, pers_o, 
                                 pers_c, pers_e, pers_e, pers_a, pers_n,
                                 socdist_tiles, rate_day, popdens, 
                                 foreign_share) %>%
  mutate_at(vars(-county_fips, -date, -time), scale)

```


## Predict prevalence
### prevalence ~ openness
```{r}

models_o_covid <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_o', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_o_covid)

compare_models(models_o_covid)

```

### prevalence ~ conscientiousness
```{r}

models_c_covid <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_c', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_c_covid)

compare_models(models_c_covid)


```

### prevalence ~ extraversion
```{r}

models_e_covid <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_e', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_e_covid)

compare_models(models_e_covid)


```

### prevalence ~ agreeableness
```{r}

models_a_covid <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_a', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_a_covid)

compare_models(models_a_covid)


```

### prevalence ~ neuroticism
```{r}

models_n_covid <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_n', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_n_covid)

compare_models(models_n_covid)


```


## Predict social distancing
### social distancing ~ openness
```{r}

models_o_sd <-run_models(y = 'socdist_tiles', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_o', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_o_sd)

compare_models(models_o_sd)


```

### social distancing ~ conscientiousness
```{r}

models_c_sd <-run_models(y = 'socdist_tiles', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_c', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_c_sd)

compare_models(models_c_sd)


```

### social distancing ~ extraversion
```{r}

models_e_sd <-run_models(y = 'socdist_tiles', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_e', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_e_sd)

compare_models(models_e_sd)


```

### social distancing ~ agreeableness
```{r}

models_a_sd <-run_models(y = 'socdist_tiles', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_a', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_a_sd)

compare_models(models_a_sd)


```

### social distancing ~ neuroticism
```{r}

models_n_sd <-run_models(y = 'socdist_tiles', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_n', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'dem')

extract_results(models_n_sd)

compare_models(models_n_sd)

```


## Explore quadratic trends 

### prevalence ~ openness
```{r}

models_o_covid_exp <-run_models(y = 'rate_day',
                         lvl1_x = 'time',
                         lvl2_x = 'pers_o',
                         lvl2_id = 'county_fips',
                         data = df_us_scaled,
                         ctrls = 'exp')

extract_results(models_o_covid_exp)

compare_models(models_o_covid_exp)

```


## prevalence ~ conscientiousness
```{r}

models_c_covid_exp <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_c', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'exp')

extract_results(models_c_covid_exp)

compare_models(models_c_covid_exp)

```

### prevalence ~ extraversion
```{r}

models_e_covid_exp <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_e', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'exp')

extract_results(models_e_covid_exp)

compare_models(models_e_covid_exp)

```

### prevalence ~ agreeableness
```{r}

models_a_covid_exp <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_a', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'exp')

extract_results(models_a_covid_exp)

compare_models(models_a_covid_exp)

```

### prevalence ~ neuroticism
```{r}

models_n_covid_exp <-run_models(y = 'rate_day', 
                         lvl1_x = 'time', 
                         lvl2_x = 'pers_n', 
                         lvl2_id = 'county_fips', 
                         data = df_us_scaled,
                         ctrls = 'exp')

extract_results(models_n_covid_exp)

compare_models(models_n_covid_exp)

```


## Create overview table 

### Define function to create overview tables
```{r}

summary_table <- function(models, dv_name){

  temp_df_ctrl_main <- NULL
  temp_df_ctrl_int <- NULL
  
  for (i in models){
    results <- i %>% extract_results()
    
    results_ctrl_main <- results$interaction_ctrl_main_dem['lvl1_x:lvl2_x',]
    temp_df_ctrl_main <- temp_df_ctrl_main %>% rbind(results_ctrl_main)
    
    results_ctrl_int <- results$interaction_ctrl_int_dem['lvl1_x:lvl2_x',]
    temp_df_ctrl_int <- temp_df_ctrl_int %>% rbind(results_ctrl_int)
  }
  
  names_ctrl_main <- paste0(dv_name, '~', c('o', 'c', 'e', 'a', 'n'), '*time', '_crtl_popdens')
  names_ctrl_int <- paste0(dv_name, '~', c('o', 'c', 'e', 'a', 'n'), '*time', '_crtl_popdens*time')

  rownames(temp_df_ctrl_main) <- names_ctrl_main
  rownames(temp_df_ctrl_int) <- names_ctrl_int
  
  sum_tab <- rbind(temp_df_ctrl_main, temp_df_ctrl_int) %>% round(4)
  
  return(sum_tab)

} 

```

### Create overview tables
```{r}
# prevalence
models_prev <- list(models_o_covid, 
                    models_c_covid, 
                    models_e_covid, 
                    models_a_covid, 
                    models_n_covid)

sum_tab_prev <- summary_table(models_prev, dv_name = 'prev')

write.table(sum_tab_prev, quote=F)

# social distancing
models_socdist <- list(models_o_sd, 
                       models_c_sd, 
                       models_e_sd, 
                       models_a_sd, 
                       models_n_sd)

sum_tab_socdist <- summary_table(models_socdist, dv_name = 'socdist')

write.table(sum_tab_socdist, quote=F)



```




# Conditional random forest analysis 

### Extract slopes
```{r}

# slope prevalence
df_us_slope_prev <- df_us %>% split(.$county) %>% 
  map(~ lm(rate_day ~ time, data = .)) %>%
  map(coef) %>% 
  map_dbl('time') %>% 
  as.data.frame() %>% 
  rownames_to_column('county_fips') %>% 
  rename(slope_prev = '.')

df_us_slope_prev <- df_us %>% select(county_fips:pers_n) %>%
  distinct() %>% 
  mutate(county_fips = as.character(county_fips)) %>%
  inner_join(df_us_slope_prev, by = 'county_fips') %>%
  select(-viocrime, -assn2014, -sk2014, -trade_element_share,
       -manag_share, -patents, -married_share, -purewhite_share,
       -lifeexp_2010_14, -male_share, -creative_share, -rep2008, 
       -dem2008, -other2008, -totalpop, -population)


# slope social distancing
df_us_slope_socdist <- df_us %>% split(.$county) %>% 
  map(~ lm(socdist_tiles ~ time, data = .)) %>%
  map(coef) %>% 
  map_dbl('time') %>% 
  as.data.frame() %>% 
  rownames_to_column('county_fips') %>% 
  rename(slope_socdist = '.')

df_us_slope_socdist <- df_us %>% select(county_fips:pers_n) %>%
  distinct() %>% 
  mutate(county_fips = as.character(county_fips)) %>%
  inner_join(df_us_slope_socdist, by = 'county_fips') %>%
  select(-viocrime, -assn2014, -sk2014, -trade_element_share,
         -manag_share, -patents, -married_share, -purewhite_share,
         -lifeexp_2010_14, -male_share, -creative_share, -rep2008, 
         -dem2008, -other2008, -totalpop, -population)

```

### Explore distribution of slopes
```{r}
df_us_slopes_prev %>% ggplot(aes(slope_prev)) + geom_histogram(bins = 100)

df_us_slopes_socdist %>% ggplot(aes(slope_socdist)) + geom_histogram(bins = 100)

```

# CRF prevalence
```{r}

ctrls <- cforest_unbiased(ntree=500, mtry=5)

crf_fit_prev <- cforest(slope_prev ~ ., 
                         df_us_slope_prev[-1], 
                         controls = ctrls)

crf_varimp_prev <- varimp(crf_fit_prev, nperm = 5)
crf_varimp_cond_prev <- varimp(crf_fit_prev, conditional = T)

crf_varimp_prev %>% as.data.frame() %>% rownames_to_column('variable') %>%
  ggplot(aes(x=variable, y=.)) +
  geom_bar(stat = 'identity') + 
  theme(axis.text.x = element_text(angle = 90))

crf_varimp_cond_prev %>% as.data.frame() %>% rownames_to_column('variable') %>%
  ggplot(aes(x=variable, y=.)) +
  geom_bar(stat = 'identity') + 
  theme(axis.text.x = element_text(angle = 90))

```

# CRF social distancing
```{r}

ctrls <- cforest_unbiased(ntree=500, mtry=5)

crf_fit_socdist <- cforest(slope_socdist ~ ., 
                         df_us_slope_socdist[-1], 
                         controls = ctrls)

crf_varimp_socdist <- varimp(crf_fit_socdist, nperm = 5)
crf_varimp_cond_socdist <- varimp(crf_fit_socdist, conditional = T)

crf_varimp_socdist %>% as.data.frame() %>% rownames_to_column('variable') %>%
  ggplot(aes(x=variable, y=.)) +
  geom_bar(stat = 'identity') + 
  theme(axis.text.x = element_text(angle = 90))

crf_varimp_cond_socdist %>% as.data.frame() %>% rownames_to_column('variable') %>%
  ggplot(aes(x=variable, y=.)) +
  geom_bar(stat = 'identity') + 
  theme(axis.text.x = element_text(angle = 90))

```