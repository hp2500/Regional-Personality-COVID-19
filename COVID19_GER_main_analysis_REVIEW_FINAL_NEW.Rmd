---
title: "COVID19 GER"
author: "Heinrich Peters"
date: "11/04/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath('../Data/GER'))
options(tibble.print_max = 25)

library(lmerTest)
library(nlme)
library(psych)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(party)
library(survminer)
library(survival)
library(survMisc)
library(changepoint)

source('COVID19_functions.R')
```

# Prepare data
### Read and format prevalence data 
```{r}
df_ger_prev <- read_csv('GER_prevalence.csv')

df_ger_prev <- df_ger_prev %>%
  mutate(date = as.Date(date, "%d%b%Y"),
         kreis = as.character(kreis)) %>% 
  dplyr::select(kreis, date, rate_day) %>%
  filter(date < '2020-04-01')

df_ger_prev %>% write_csv('ger_prev_kreis.csv')
```

```{r}
df_ger_death <- read_csv('GER_prevalence.csv')

df_ger_death <-  df_ger_death %>%
  mutate(date = as.Date(date, "%d%b%Y"), 
         kreis = as.character(kreis))

df_ger_death <- df_ger_death %>% 
  filter(date == '2020-09-30') %>% 
  rename(case_rate = rate_day,
         death_rate = death_day) %>% 
  select(kreis, case_rate, death_rate)

# save df
df_ger_death %>% write_csv('ger_death_kreis_maps.csv')
```

### Read and format scoial distancing data
```{r message=FALSE, warning=FALSE}
fb_files <- list.files('../FB Data/GER individual files',
                       '*.csv', full.names = T)

df_ger_socdist <- fb_files %>% 
  map(read.csv) %>% bind_rows()

kreis_match <- read_csv('kreismatch.csv')

df_ger_socdist <- df_ger_socdist %>%
  select(-polygon_name) %>%
  plyr::join(kreis_match, by = 'polygon_id') %>%
  select(kreis, ds, all_day_bing_tiles_visited_relative_change,
         all_day_ratio_single_tile_users) %>%
  rename(date = ds,
         socdist_tiles = all_day_bing_tiles_visited_relative_change,
         socdist_single_tile = all_day_ratio_single_tile_users) %>%
  mutate(kreis = as.character(kreis),
         date = as.Date(date)) %>%
  arrange(kreis, date)
```

### Read and format personality data 
```{r message=FALSE, warning=FALSE}
df_ger_pers <- read_csv('GER_personality_2.csv')

df_ger_pers %>% filter(frequ >= 50) %>% .$frequ %>% mean()

df_ger_pers <- df_ger_pers %>% 
  filter(frequ >= 50) %>%
  select(kreis, open, sci, extra, agree, neuro) %>%
  dplyr::rename(pers_o = open,
         pers_c = sci,
         pers_e = extra,
         pers_a = agree,
         pers_n = neuro) %>%
  distinct() %>%
  mutate(kreis = as.character(kreis))
```

### Read and format county level controls 
```{r}
df_ger_ctrl <- read_csv('GER_controls_2.csv')

df_ger_ctrl <- df_ger_ctrl %>%
  select(-gdp, -cdu, -kreis_nme) %>%
  rename(tourism = tourism_beds,
         healthcare = hospital_beds,
         airport_dist = airport,
         conservative = afd) %>%
  mutate(kreis = as.character(kreis))

df_ger_pers %>% merge(df_ger_ctrl, by='kreis') %>% 
  write_csv('df_ger_pers_kreis.csv')
```

### Merge prevalence data 
```{r}
# create sequence of dates
date_sequence <- seq.Date(min(df_ger_prev$date),
                          max(df_ger_prev$date), 1)
                     
# create data frame with time sequence
df_dates = tibble(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')

# merge prevalence data
df_ger_prev <- df_ger_prev %>% 
  inner_join(df_ger_pers, by = 'kreis') %>%
  inner_join(df_ger_ctrl, by = 'kreis') %>%
  merge(df_dates, by='date') %>%
  arrange(kreis, date) %>%
  drop_na()

df_ger_prev %>% select(kreis) %>% distinct() %>% nrow()
```

```{r}
# join data frames
df_ger_death <- df_ger_death %>%
  plyr::join(df_ger_ctrl, by='kreis') %>%
  plyr::join(df_ger_pers, by='kreis') %>%
  drop_na()

# save df
df_ger_death %>%
  #select(kreis, case_rate, death_rate) %>%
  write_csv('ger_death_kreis_controls.csv')
```

### Merge social distancing data
```{r}
# create sequence of dates
date_sequence <- seq.Date(min(df_ger_socdist$date),
                          max(df_ger_socdist$date), 1)
                     
# create data frame with time sequence
df_dates = tibble(date_sequence, 1:length(date_sequence))
names(df_dates) <- c('date', 'time')

# merge socdist data
df_ger_socdist <- df_ger_socdist %>% 
  inner_join(df_ger_pers, by = 'kreis') %>%
  inner_join(df_ger_ctrl, by = 'kreis') %>% 
  merge(df_dates, by='date') %>% 
  arrange(kreis)

df_ger_socdist %>% select(kreis) %>% distinct() %>% nrow()

```

### Control for weekend effect 
```{r}
easter <- seq.Date(as.Date('2020-04-10'), as.Date('2020-04-13'), 1)

df_ger_loess <- df_ger_socdist %>% 
  mutate(weekday = format(date, '%u')) %>% 
  filter(!(weekday %in% c('6','7') | date %in% easter)) %>% 
  split(.$kreis) %>%
  map(~ loess(socdist_single_tile ~ time, data = .)) %>%
  map(predict, 1:max(df_ger_socdist$time)) %>% 
  bind_rows() %>% 
  gather(key = 'kreis', value = 'loess') %>% 
  group_by(kreis) %>% 
  mutate(time = row_number())

df_ger_loess_2 <- df_ger_socdist %>% 
  mutate(weekday = format(date, '%u')) %>% 
  filter(!(weekday %in% c('6','7') | date %in% easter)) %>% 
  split(.$kreis) %>%
  map(~ loess(socdist_tiles ~ time, data = .)) %>%
  map(predict, 1:max(df_ger_socdist$time)) %>% 
  bind_rows() %>% 
  gather(key = 'kreis', value = 'loess') %>% 
  rename(loess_2 = loess) %>%
  group_by(kreis) %>% 
  mutate(time = row_number())


df_ger_socdist <- df_ger_socdist %>% 
  merge(df_ger_loess, by=c('kreis', 'time')) %>% 
  merge(df_ger_loess_2, by=c('kreis', 'time')) %>% 
  mutate(weekday = format(date, '%u')) %>% 
  mutate(socdist_single_tile_clean = ifelse(weekday %in% c('6','7') | date %in% easter, 
                                            loess, socdist_single_tile),
         socdist_tiles_clean = ifelse(weekday %in% c('6','7') | date %in% easter, 
                                            loess_2, socdist_tiles)) %>%
  arrange(kreis, time) %>% 
  select(-weekday)

df_ger_socdist <- df_ger_socdist %>% drop_na() %>% mutate(time = time-1)
```

### Include cleaned social distancing data 
```{r}
df_ger_socdist <- df_ger_socdist %>% 
  mutate(socdist_single_tile = socdist_single_tile_clean,
         socdist_tiles = socdist_tiles_clean) %>% 
  select(-loess, -loess_2, -socdist_single_tile_clean, -socdist_tiles_clean)
```

### Rescale data
```{r}
lvl2_scaled <- df_ger_prev %>% 
  dplyr::select(-time, -rate_day, -date) %>% 
  distinct() %>% 
  mutate_at(vars(-kreis), scale)
  
lvl1_scaled <- df_ger_prev %>% select(kreis, date, time, rate_day)

df_ger_prev_scaled <- plyr::join(lvl1_scaled, lvl2_scaled, by = 'kreis')
```

```{r}
df_ger_death_scaled <- df_ger_death %>% 
  mutate_at(vars(-kreis), scale)
```

```{r}
lvl2_scaled <- df_ger_socdist %>% 
  dplyr::select(-time, -socdist_single_tile, -socdist_tiles, -date) %>% 
  distinct() %>% 
  mutate_at(vars(-kreis), scale)
  
lvl1_scaled <- df_ger_socdist %>% select(kreis, date, time, socdist_single_tile, socdist_tiles)

df_ger_socdist_scaled <- plyr::join(lvl1_scaled, lvl2_scaled, by = 'kreis')
```

# Define outcomes of interest
### COVID - Extract onset
```{r}
# get onset day
df_ger_onset_prev <- df_ger_prev_scaled %>% 
  group_by(kreis) %>% 
  filter(rate_day > 0.1) %>%
  summarise(onset_prev = min(time))
  
# merge with county data
df_ger_onset_prev <- df_ger_prev_scaled %>% 
  select(-date, -time, -rate_day) %>%
  distinct() %>% 
  left_join(df_ger_onset_prev, by = 'kreis')

# handle censored data
df_ger_onset_prev <- df_ger_onset_prev %>% 
  mutate(event = ifelse(is.na(onset_prev), 0, 1)) %>% 
  mutate(onset_prev = replace_na(onset_prev, as.numeric(diff(range(df_ger_prev$date)))+1))
```

### COVID - Extract slopes
```{r}
# cut time series
df_ger_prev_scaled <- df_ger_prev_scaled %>% 
  filter(date > '2020-03-01' & date < '2020-04-01')

# extract slope prevalence
df_ger_slope_prev <- df_ger_prev_scaled %>% 
  split(.$kreis) %>% 
  map(~ lm(log(rate_day+1) ~ time, data = .)) %>%
  map(coef) %>% 
  map_dbl('time') %>% 
  as.data.frame() %>% 
  rownames_to_column('kreis') %>%
  rename(slope_prev = '.')

# merge with county data
df_ger_slope_prev <- df_ger_onset_prev %>% 
  left_join(df_ger_slope_prev, by = 'kreis') %>%
  mutate(slope_prev = replace_na(slope_prev, 0))

# standardize slopes
df_ger_slope_prev <- df_ger_slope_prev %>% 
  mutate(slope_prev = scale(slope_prev),
         onset_prev = scale(onset_prev))
```

### Social Distancing - Change point analysis
```{r}
# keep only counties with full data
kreis_complete <- df_ger_socdist_scaled %>% 
  group_by(kreis) %>% 
  summarise(n = n()) %>% 
  filter(n==max(.$n)) %>% 
  .$kreis

# run changepoint analysis
df_ger_socdist_cpt_results <- df_ger_socdist_scaled %>% 
  select(kreis, socdist_single_tile) %>%
  filter(kreis %in% kreis_complete) %>% 
  split(.$kreis) %>%
  map(~ cpt.meanvar(as.vector(.$socdist_single_tile),
                    #penalty = 'Asymptotic',
                    class=TRUE,
                    param.estimates=TRUE,
                    Q=1,
                    test.stat = 'Normal'))

df_ger_socdist_cpt_results_2 <- df_ger_socdist_scaled %>% 
  select(kreis, socdist_tiles) %>%
  filter(kreis %in% kreis_complete) %>% 
  split(.$kreis) %>%
  map(~ cpt.meanvar(as.vector(.$socdist_tiles),
                    class=TRUE,
                    param.estimates=TRUE,
                    Q=1,
                    test.stat = 'Normal'))

# calculate change point
df_ger_socdist_cpt_day <- df_ger_socdist_cpt_results %>% 
  map(cpts) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(cpt_day_socdist = '.') %>%
  rownames_to_column('kreis')

df_ger_socdist_cpt_day_2 <- df_ger_socdist_cpt_results_2 %>% 
  map(cpts) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(cpt_day_socdist_2 = '.') %>%
  rownames_to_column('kreis')

# calculate mean differences
df_ger_socdist_cpt_mean_diff <- df_ger_socdist_cpt_results %>% 
  map(param.est) %>% 
  map(~ .$mean) %>% 
  map(~ .[2]) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(mean_diff_socdist = '.') %>%
  rownames_to_column('kreis')

df_ger_socdist_cpt_mean_diff_2 <- df_ger_socdist_cpt_results_2 %>% 
  map(param.est) %>% 
  map(~ .$mean) %>% 
  map(~ -.[2]) %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rename(mean_diff_socdist_2 = '.') %>%
  rownames_to_column('kreis')

# calculate means 
df_ger_socdist_mean <- df_ger_socdist_scaled %>%
  group_by(kreis) %>%
  summarise(mean_socdist = mean(socdist_single_tile))

df_ger_socdist_mean_2 <- df_ger_socdist_scaled %>%
  group_by(kreis) %>%
  summarise(mean_socdist_2 = -mean(socdist_tiles))

# merge with county data
df_ger_cpt_socdist <- df_ger_socdist_scaled %>%
  select(-date, -time, -socdist_single_tile, -socdist_tiles) %>%
  distinct() %>%
  left_join(df_ger_socdist_cpt_day, by='kreis') %>%
  left_join(df_ger_socdist_cpt_day_2, by='kreis') %>%
  left_join(df_ger_socdist_cpt_mean_diff, by='kreis') %>%
  left_join(df_ger_socdist_cpt_mean_diff_2, by='kreis') %>%
  left_join(df_ger_socdist_mean, by='kreis') %>%
  left_join(df_ger_socdist_mean_2, by='kreis') %>%
  left_join(select(df_ger_onset_prev, kreis, onset_prev), by='kreis') %>%
  left_join(select(df_ger_slope_prev, kreis, slope_prev), by='kreis')

# standardize mean/var differences
df_ger_cpt_socdist <- df_ger_cpt_socdist %>%
  mutate(mean_diff_socdist = scale(mean_diff_socdist),
         mean_diff_socdist_2 = scale(mean_diff_socdist_2),
         mean_socdist = scale(mean_socdist),
         mean_socdist_2 = scale(mean_socdist_2))

# handle censored data
df_ger_cpt_socdist <- df_ger_cpt_socdist %>% 
  mutate(cpt_day_socdist = ifelse(is.na(cpt_day_socdist), 
                                  as.numeric(diff(range(df_ger_socdist$date))), 
                                  cpt_day_socdist)) %>% 
  mutate(event = ifelse(cpt_day_socdist >= 
                          as.numeric(diff(range(df_ger_socdist$date))), 0, 1))
```

# Fit models
### Predict COVID onset
```{r}
ger_cox_prev_onset <- run_analyses(y = 'onset_prev',  data = df_ger_slope_prev, model = 'cox')
```

### Predict COVID growth
```{r}
ger_lm_prev_slope <- run_analyses(y = 'slope_prev',  data = df_ger_slope_prev, model = 'lm')
```

### Predict COVID case rate
```{r}
ger_lm_prev_cases <- run_analyses(y = 'case_rate',  data = df_ger_death_scaled, model = 'lm')
```

### Predict COVID death rate
```{r}
ger_lm_prev_deaths <- run_analyses(y = 'death_rate',  data = df_ger_death_scaled, model = 'lm')
```

### Predict socdist change points
```{r}
ger_cox_socdist_cpt <- run_analyses(y = 'cpt_day_socdist_2',  data = df_ger_cpt_socdist, model = 'cox')
```

### Predict socdist means
```{r}
ger_lm_socdist_mean <- run_analyses(y = 'mean_diff_socdist_2',  data = df_ger_cpt_socdist, model = 'lm')
```

# Export data 
```{r}

ger_list_results <- list(ger_cox_prev_onset, ger_lm_prev_slope,
                         ger_lm_prev_cases, ger_lm_prev_deaths,
                         ger_cox_socdist_cpt, ger_lm_socdist_mean)

ger_results_names <- list('ger_cox_prev_onset', 'ger_lm_prev_slope',
                          'ger_lm_prev_cases', 'ger_lm_prev_deaths',
                      'ger_cox_socdist_cpt', 'ger_lm_socdist_mean')

names(ger_list_results) <- ger_results_names

save(ger_list_results, file="ger_list_results_fixed_window.RData")
```

# Extract results
### Results - predict COVID onset
```{r}
ger_agg_prev_onset <- ger_list_results$ger_cox_prev_onset %>% extract_all()
```

### Results - predict COVID growth
```{r}
ger_agg_prev_slope <- ger_list_results$ger_lm_prev_slope %>% extract_all()
```

### Results - predict COVID case rates
```{r}
ger_agg_prev_cases <- ger_list_results$ger_lm_prev_cases %>% extract_all()
```

### Results - predict COVID death rates
```{r}
ger_agg_prev_deaths <- ger_list_results$ger_lm_prev_deaths %>% extract_all()
```

### Results - predict socdist start
```{r}
ger_agg_socdist_cpt <- ger_list_results$ger_cox_socdist_cpt %>% extract_all()
```

### Results - predict socdist means
```{r}
ger_agg_socdist_mean <- ger_list_results$ger_lm_socdist_mean %>% extract_all()
```

### Save aggregated results
```{r}

ger_agg_fixed_window <- list(ger_agg_prev_onset,
               ger_agg_prev_slope,
               ger_agg_prev_cases,
               ger_agg_prev_deaths,
               ger_agg_socdist_cpt,
               ger_agg_socdist_mean
               )

names(ger_agg_fixed_window) <- ger_results_names

save(ger_agg_fixed_window, file="ger_agg_fixed_window.RData")
```

```{r}
write_csv(df_ger_slope_prev, 'df_ger_slope_prev.csv')
write_csv(df_ger_cpt_socdist, 'df_ger_cpt_socdist.csv')
write_csv(df_ger_death_scaled, 'df_ger_death_scaled.csv')

```

### Display aggregated results 
```{r}
ger_agg_fixed_window
```


# Descriptives
### Distributions
```{r}
df_ger_desc <- df_ger_socdist %>% 
  dplyr::select(pers_o, pers_c, pers_e, pers_a, pers_n, 
                age, male, conservative, 
                academics, medinc, manufact, 
                airport_dist, tourism, healthcare, popdens) %>% 
  distinct() %>% drop_na()

ger_means <- df_ger_desc %>% summarise_all(mean)
ger_sd <- df_ger_desc %>% summarise_all(sd)

desc_ger <- rbind(ger_means, ger_sd) %>% t() %>% round(3) %>% as.data.frame()

desc_ger %>% rownames_to_column() %>% write_csv('ger_descriptives.csv')
desc_ger 
```

### Explore correlations
```{r}
a <- df_ger_cpt_socdist %>% select(kreis, cpt_day_socdist, mean_diff_socdist)
b <- df_ger_slope_prev %>% select(kreis, onset_prev, slope_prev)
c <- df_ger_death_scaled %>% select(kreis, case_rate, death_rate)

plyr::join_all(list(a, b, c), by='kreis') %>% select(-kreis) %>% cor(use = 'pairwise.complete')
```

# Visualizations 
```{r}
# create sequence of dates
date_sequence <- seq.Date(min(df_ger_prev$date),
                          max(df_ger_prev$date), 1)
                     
# create data frame with time sequence
df_dates = data.frame(date_sequence, 1:length(date_sequence))
names(df_dates) <- c('date', 'time')

tto <- df_ger_onset_prev %>%
  filter(event==1) %>%
  merge(df_dates, by.x = 'onset_prev', by.y = 'time') %>%
  ggplot(aes(x=date+1)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - COVID-19 Onset') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Date')
  
soa <- df_ger_slope_prev %>% 
  ggplot(aes(x=slope_prev)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - COVID-19 Growth Rates') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Standardized growth rates')

figure <- ggarrange(tto, soa,
                    labels = c("", ""),
                    ncol = 2, nrow = 1)

figure
```
```{r}
tto <- df_ger_death %>% 
  ggplot(aes(x=case_rate)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Cumulative Case Rates') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Cases Per 1000 Inhabitants')
  
soa <- df_ger_death %>%
  ggplot(aes(x=death_rate)) +
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Cumulative Death Rates') +
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Deaths Per 1000 Inhabitants')


figure <- ggarrange(tto, soa,
                    labels = c("", ""),
                    ncol = 2, nrow = 1)
figure
```

```{r}
# create sequence of dates
date_sequence <- seq.Date(min(df_ger_socdist$date),
                          max(df_ger_socdist$date), 1)
                     
# create data frame with time sequence
df_dates = data.frame(date_sequence, 1:length(date_sequence)) 
names(df_dates) <- c('date', 'time')


tto <- df_ger_cpt_socdist %>% 
  merge(df_dates, by.x = 'cpt_day_socdist_2', by.y = 'time') %>%
  #filter(cpt_day_socdist_2 < 30) %>% 
  ggplot(aes(x=date+1)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Time to Adoption') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Date') +
  xlim(c(as.Date('2020-03-01'), as.Date('2020-03-31')))
  
soa <- df_ger_cpt_socdist %>% 
  ggplot(aes(x=mean_diff_socdist_2)) + 
  geom_histogram(bins=15) +
  theme_light() +
  ggtitle('Distribution - Strength of Adjustment') + 
  theme(plot.title = element_text(size=11)) +
  ylab('Absolute frequency') +
  xlab('Standardized mean difference')


figure <- ggarrange(tto, soa,
                    labels = c("", ""),
                    ncol = 2, nrow = 1)
figure
```
